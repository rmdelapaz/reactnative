<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Implement authentication flows in Expo Router - protected routes, auth context, secure storage, and login/logout patterns">
    <meta name="author" content="React Native & Expo Course">
    <title>Authentication Flows | Module 6: Navigation with Expo Router | React Native & Expo Course</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="icon" type="image/png" href="favicon.png">
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true, theme: 'neutral' });
    </script>
</head>
<body>
    <!-- Skip to main content for accessibility -->
    <a href="#main-content" class="skip-to-main">Skip to main content</a>

    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <a href="index.html" class="nav-logo">üì± RN Course</a>
            <button id="mobile-menu-toggle" class="mobile-menu-toggle" aria-expanded="false" aria-controls="nav-links">
                ‚ò∞
            </button>
            <div class="nav-links" id="nav-links">
                <a href="index.html">Home</a>
                <a href="index.html#modules">Modules</a>
                <a href="index.html#appendices">Appendices</a>
                <button id="theme-toggle" aria-label="Toggle theme">üåô</button>
            </div>
        </div>
    </nav>

    <!-- Breadcrumb -->
    <div class="breadcrumb">
        <div class="container">
            <a href="index.html">Home</a> &gt;
            <a href="index.html#modules">Modules</a> &gt;
            <a href="m06_l01_navigation_concepts.html">Module 6</a> &gt;
            <span>Lesson 6.6</span>
        </div>
    </div>

    <!-- Main Content -->
    <main id="main-content">
        <div class="container">
            <!-- Lesson Header -->
            <header>
                <p class="module-tag">Module 6: Navigation with Expo Router</p>
                <h1>Authentication Flows</h1>
                <p class="lesson-subtitle">Building secure, user-friendly authentication with protected routes</p>
            </header>

            <!-- Learning Objectives -->
            <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h2 style="color: white; border: none; margin-top: 0;">üéØ Learning Objectives</h2>
                <ul style="color: white;">
                    <li>Build a complete authentication context with React Context</li>
                    <li>Store authentication tokens securely with Expo SecureStore</li>
                    <li>Implement protected routes that redirect unauthenticated users</li>
                    <li>Handle loading states during authentication checks</li>
                    <li>Create login, registration, and password reset flows</li>
                    <li>Implement persistent login across app restarts</li>
                    <li>Handle token refresh and session expiration</li>
                </ul>
            </div>

            <!-- Table of Contents -->
            <div class="toc-container">
                <details class="toc-details" open>
                    <summary>üìë Table of Contents</summary>
                    <ul class="toc-list">
                        <li><a href="#auth-overview">Authentication Overview</a></li>
                        <li><a href="#secure-storage">Secure Token Storage</a></li>
                        <li><a href="#auth-context">Building the Auth Context</a></li>
                        <li><a href="#protected-routes">Protected Routes</a></li>
                        <li><a href="#auth-screens">Authentication Screens</a></li>
                        <li><a href="#session-management">Session Management</a></li>
                        <li><a href="#exercises">Hands-On Exercises</a></li>
                        <li><a href="#summary">Summary</a></li>
                    </ul>
                </details>
            </div>

            <!-- Authentication Overview -->
            <section id="auth-overview">
                <h2>Authentication Overview</h2>

                <p>Authentication in mobile apps involves verifying user identity, managing sessions, and controlling access to protected content. A well-designed auth flow provides security without sacrificing user experience.</p>

                <h3>Auth Flow Architecture</h3>

                <pre class="mermaid">
flowchart TD
    A[App Starts] --> B{Check stored token}
    B -->|No token| C[Show Auth Screens]
    B -->|Has token| D{Validate token}
    D -->|Valid| E[Show Main App]
    D -->|Invalid/Expired| F{Can refresh?}
    F -->|Yes| G[Refresh token]
    F -->|No| C
    G -->|Success| E
    G -->|Failure| C
    
    C --> H[User logs in]
    H --> I[Store token securely]
    I --> E
    
    E --> J[User logs out]
    J --> K[Clear stored token]
    K --> C
    
    style E fill:#e8f5e9
    style C fill:#fff3cd
                </pre>

                <h3>Key Components</h3>

                <div class="card">
                    <h4>üîê Authentication System Components</h4>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f5f5f5;">
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Component</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Purpose</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 12px; border-bottom: 1px solid #eee;"><strong>Auth Context</strong></td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee;">Global state for user and authentication status</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; border-bottom: 1px solid #eee;"><strong>Secure Storage</strong></td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee;">Encrypted storage for tokens (SecureStore)</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; border-bottom: 1px solid #eee;"><strong>Protected Routes</strong></td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee;">Routes that require authentication to access</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; border-bottom: 1px solid #eee;"><strong>Auth Screens</strong></td>
                                <td style="padding: 12px; border-bottom: 1px solid #eee;">Login, Register, Forgot Password screens</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px;"><strong>API Integration</strong></td>
                                <td style="padding: 12px;">Backend communication with token headers</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <h3>File Structure</h3>

                <pre><code class="language-text">app/
‚îú‚îÄ‚îÄ _layout.tsx                 # Root layout with AuthProvider
‚îú‚îÄ‚îÄ (auth)/                     # Public auth screens
‚îÇ   ‚îú‚îÄ‚îÄ _layout.tsx
‚îÇ   ‚îú‚îÄ‚îÄ login.tsx
‚îÇ   ‚îú‚îÄ‚îÄ register.tsx
‚îÇ   ‚îî‚îÄ‚îÄ forgot-password.tsx
‚îú‚îÄ‚îÄ (app)/                      # Protected screens
‚îÇ   ‚îú‚îÄ‚îÄ _layout.tsx             # Protected layout wrapper
‚îÇ   ‚îî‚îÄ‚îÄ (tabs)/
‚îÇ       ‚îú‚îÄ‚îÄ _layout.tsx
‚îÇ       ‚îî‚îÄ‚îÄ ...
context/
‚îú‚îÄ‚îÄ AuthContext.tsx             # Auth state and methods
hooks/
‚îú‚îÄ‚îÄ useAuth.ts                  # Auth hook
‚îú‚îÄ‚îÄ useProtectedRoute.ts        # Route protection hook
services/
‚îú‚îÄ‚îÄ auth.ts                     # Auth API calls
‚îú‚îÄ‚îÄ secureStorage.ts            # Token storage utilities</code></pre>
            </section>

            <!-- Secure Token Storage -->
            <section id="secure-storage">
                <h2>Secure Token Storage</h2>

                <p>Never store authentication tokens in plain AsyncStorage. Use Expo SecureStore which provides encrypted storage backed by the device's secure enclave (iOS Keychain / Android Keystore).</p>

                <h3>Installing SecureStore</h3>

                <pre><code class="language-bash">npx expo install expo-secure-store</code></pre>

                <h3>Storage Utility</h3>

                <pre><code class="language-tsx">// services/secureStorage.ts
import * as SecureStore from 'expo-secure-store';
import { Platform } from 'react-native';

const TOKEN_KEY = 'auth_token';
const REFRESH_TOKEN_KEY = 'refresh_token';
const USER_KEY = 'user_data';

// SecureStore is not available on web, use a fallback
const isSecureStoreAvailable = Platform.OS !== 'web';

export const secureStorage = {
  // Store auth token
  async setToken(token: string): Promise&lt;void&gt; {
    if (isSecureStoreAvailable) {
      await SecureStore.setItemAsync(TOKEN_KEY, token);
    } else {
      // Web fallback (less secure, for development only)
      localStorage.setItem(TOKEN_KEY, token);
    }
  },

  // Get auth token
  async getToken(): Promise&lt;string | null&gt; {
    if (isSecureStoreAvailable) {
      return await SecureStore.getItemAsync(TOKEN_KEY);
    } else {
      return localStorage.getItem(TOKEN_KEY);
    }
  },

  // Store refresh token
  async setRefreshToken(token: string): Promise&lt;void&gt; {
    if (isSecureStoreAvailable) {
      await SecureStore.setItemAsync(REFRESH_TOKEN_KEY, token);
    } else {
      localStorage.setItem(REFRESH_TOKEN_KEY, token);
    }
  },

  // Get refresh token
  async getRefreshToken(): Promise&lt;string | null&gt; {
    if (isSecureStoreAvailable) {
      return await SecureStore.getItemAsync(REFRESH_TOKEN_KEY);
    } else {
      return localStorage.getItem(REFRESH_TOKEN_KEY);
    }
  },

  // Store user data (as JSON string)
  async setUser(user: object): Promise&lt;void&gt; {
    const userString = JSON.stringify(user);
    if (isSecureStoreAvailable) {
      await SecureStore.setItemAsync(USER_KEY, userString);
    } else {
      localStorage.setItem(USER_KEY, userString);
    }
  },

  // Get user data
  async getUser&lt;T&gt;(): Promise&lt;T | null&gt; {
    let userString: string | null;
    if (isSecureStoreAvailable) {
      userString = await SecureStore.getItemAsync(USER_KEY);
    } else {
      userString = localStorage.getItem(USER_KEY);
    }
    return userString ? JSON.parse(userString) : null;
  },

  // Clear all auth data (for logout)
  async clearAll(): Promise&lt;void&gt; {
    if (isSecureStoreAvailable) {
      await SecureStore.deleteItemAsync(TOKEN_KEY);
      await SecureStore.deleteItemAsync(REFRESH_TOKEN_KEY);
      await SecureStore.deleteItemAsync(USER_KEY);
    } else {
      localStorage.removeItem(TOKEN_KEY);
      localStorage.removeItem(REFRESH_TOKEN_KEY);
      localStorage.removeItem(USER_KEY);
    }
  },
};</code></pre>

                <div class="card" style="background: #e8f5e9; border-left: 4px solid #4CAF50;">
                    <h4>‚úÖ SecureStore Best Practices</h4>
                    <ul>
                        <li>Always use SecureStore for sensitive data (tokens, passwords)</li>
                        <li>Keep stored data minimal‚Äîdon't store entire user objects</li>
                        <li>Clear storage completely on logout</li>
                        <li>Handle storage errors gracefully</li>
                        <li>Use a web fallback for development, but note it's less secure</li>
                    </ul>
                </div>

                <div class="card" style="background-color: #fff3cd; border-left: 4px solid #ffc107;">
                    <h4>‚ö†Ô∏è SecureStore Limitations</h4>
                    <ul>
                        <li>Maximum value size: 2048 bytes</li>
                        <li>Not available on web (use fallback)</li>
                        <li>Data is tied to the app‚Äîreinstalling clears it</li>
                        <li>No automatic backup to iCloud/Google (which is good for security)</li>
                    </ul>
                </div>
            </section>

            <!-- Building the Auth Context -->
            <section id="auth-context">
                <h2>Building the Auth Context</h2>

                <p>The auth context provides global access to authentication state and methods throughout your app.</p>

                <h3>Types Definition</h3>

                <pre><code class="language-tsx">// types/auth.ts
export interface User {
  id: string;
  email: string;
  name: string;
  avatar?: string;
}

export interface AuthState {
  user: User | null;
  token: string | null;
  isAuthenticated: boolean;
  isLoading: boolean;
}

export interface LoginCredentials {
  email: string;
  password: string;
}

export interface RegisterData {
  email: string;
  password: string;
  name: string;
}

export interface AuthContextType extends AuthState {
  login: (credentials: LoginCredentials) =&gt; Promise&lt;void&gt;;
  register: (data: RegisterData) =&gt; Promise&lt;void&gt;;
  logout: () =&gt; Promise&lt;void&gt;;
  refreshSession: () =&gt; Promise&lt;boolean&gt;;
}</code></pre>

                <h3>Auth Context Implementation</h3>

                <pre><code class="language-tsx">// context/AuthContext.tsx
import { 
  createContext, 
  useContext, 
  useState, 
  useEffect, 
  useCallback,
  ReactNode 
} from 'react';
import { secureStorage } from '@/services/secureStorage';
import { authApi } from '@/services/auth';
import type { User, AuthContextType, LoginCredentials, RegisterData } from '@/types/auth';

const AuthContext = createContext&lt;AuthContextType | null&gt;(null);

interface AuthProviderProps {
  children: ReactNode;
}

export function AuthProvider({ children }: AuthProviderProps) {
  const [user, setUser] = useState&lt;User | null&gt;(null);
  const [token, setToken] = useState&lt;string | null&gt;(null);
  const [isLoading, setIsLoading] = useState(true);

  const isAuthenticated = !!token &amp;&amp; !!user;

  // Initialize auth state from storage
  useEffect(() =&gt; {
    initializeAuth();
  }, []);

  const initializeAuth = async () =&gt; {
    try {
      setIsLoading(true);
      
      // Try to get stored token
      const storedToken = await secureStorage.getToken();
      const storedUser = await secureStorage.getUser&lt;User&gt;();

      if (storedToken &amp;&amp; storedUser) {
        // Validate token with backend
        const isValid = await validateToken(storedToken);
        
        if (isValid) {
          setToken(storedToken);
          setUser(storedUser);
        } else {
          // Token invalid, try to refresh
          const refreshed = await refreshSession();
          if (!refreshed) {
            // Refresh failed, clear storage
            await secureStorage.clearAll();
          }
        }
      }
    } catch (error) {
      console.error('Auth initialization error:', error);
      await secureStorage.clearAll();
    } finally {
      setIsLoading(false);
    }
  };

  const validateToken = async (token: string): Promise&lt;boolean&gt; =&gt; {
    try {
      await authApi.validateToken(token);
      return true;
    } catch {
      return false;
    }
  };

  const login = useCallback(async (credentials: LoginCredentials) =&gt; {
    try {
      setIsLoading(true);
      
      const response = await authApi.login(credentials);
      
      // Store tokens securely
      await secureStorage.setToken(response.token);
      if (response.refreshToken) {
        await secureStorage.setRefreshToken(response.refreshToken);
      }
      await secureStorage.setUser(response.user);
      
      // Update state
      setToken(response.token);
      setUser(response.user);
    } catch (error) {
      // Re-throw for the UI to handle
      throw error;
    } finally {
      setIsLoading(false);
    }
  }, []);

  const register = useCallback(async (data: RegisterData) =&gt; {
    try {
      setIsLoading(true);
      
      const response = await authApi.register(data);
      
      // Store tokens securely
      await secureStorage.setToken(response.token);
      if (response.refreshToken) {
        await secureStorage.setRefreshToken(response.refreshToken);
      }
      await secureStorage.setUser(response.user);
      
      // Update state
      setToken(response.token);
      setUser(response.user);
    } catch (error) {
      throw error;
    } finally {
      setIsLoading(false);
    }
  }, []);

  const logout = useCallback(async () =&gt; {
    try {
      setIsLoading(true);
      
      // Notify backend (optional, for token invalidation)
      if (token) {
        try {
          await authApi.logout(token);
        } catch {
          // Ignore errors, still clear local state
        }
      }
      
      // Clear storage
      await secureStorage.clearAll();
      
      // Clear state
      setToken(null);
      setUser(null);
    } finally {
      setIsLoading(false);
    }
  }, [token]);

  const refreshSession = useCallback(async (): Promise&lt;boolean&gt; =&gt; {
    try {
      const refreshToken = await secureStorage.getRefreshToken();
      
      if (!refreshToken) {
        return false;
      }

      const response = await authApi.refreshToken(refreshToken);
      
      // Update stored tokens
      await secureStorage.setToken(response.token);
      if (response.refreshToken) {
        await secureStorage.setRefreshToken(response.refreshToken);
      }
      
      // Update state
      setToken(response.token);
      
      return true;
    } catch {
      return false;
    }
  }, []);

  const value: AuthContextType = {
    user,
    token,
    isAuthenticated,
    isLoading,
    login,
    register,
    logout,
    refreshSession,
  };

  return (
    &lt;AuthContext.Provider value={value}&gt;
      {children}
    &lt;/AuthContext.Provider&gt;
  );
}

// Custom hook for using auth context
export function useAuth(): AuthContextType {
  const context = useContext(AuthContext);
  
  if (!context) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  
  return context;
}</code></pre>

                <h3>Auth API Service</h3>

                <pre><code class="language-tsx">// services/auth.ts
import type { User, LoginCredentials, RegisterData } from '@/types/auth';

const API_URL = process.env.EXPO_PUBLIC_API_URL || 'https://api.example.com';

interface AuthResponse {
  user: User;
  token: string;
  refreshToken?: string;
}

export const authApi = {
  async login(credentials: LoginCredentials): Promise&lt;AuthResponse&gt; {
    const response = await fetch(`${API_URL}/auth/login`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(credentials),
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.message || 'Login failed');
    }

    return response.json();
  },

  async register(data: RegisterData): Promise&lt;AuthResponse&gt; {
    const response = await fetch(`${API_URL}/auth/register`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data),
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.message || 'Registration failed');
    }

    return response.json();
  },

  async logout(token: string): Promise&lt;void&gt; {
    await fetch(`${API_URL}/auth/logout`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
      },
    });
  },

  async validateToken(token: string): Promise&lt;User&gt; {
    const response = await fetch(`${API_URL}/auth/me`, {
      headers: {
        'Authorization': `Bearer ${token}`,
      },
    });

    if (!response.ok) {
      throw new Error('Invalid token');
    }

    return response.json();
  },

  async refreshToken(refreshToken: string): Promise&lt;AuthResponse&gt; {
    const response = await fetch(`${API_URL}/auth/refresh`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ refreshToken }),
    });

    if (!response.ok) {
      throw new Error('Token refresh failed');
    }

    return response.json();
  },

  async forgotPassword(email: string): Promise&lt;void&gt; {
    const response = await fetch(`${API_URL}/auth/forgot-password`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ email }),
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.message || 'Request failed');
    }
  },
};</code></pre>
            </section>

            <!-- Protected Routes -->
            <section id="protected-routes">
                <h2>Protected Routes</h2>

                <p>Protected routes ensure that only authenticated users can access certain parts of your app. Unauthenticated users are automatically redirected to the login screen.</p>

                <h3>Root Layout with Auth Provider</h3>

                <pre><code class="language-tsx">// app/_layout.tsx
import { useEffect } from 'react';
import { Slot, useRouter, useSegments } from 'expo-router';
import { AuthProvider, useAuth } from '@/context/AuthContext';
import { View, ActivityIndicator, StyleSheet } from 'react-native';

// Auth state listener component
function AuthStateListener({ children }: { children: React.ReactNode }) {
  const { isAuthenticated, isLoading } = useAuth();
  const segments = useSegments();
  const router = useRouter();

  useEffect(() =&gt; {
    if (isLoading) return;

    const inAuthGroup = segments[0] === '(auth)';

    if (!isAuthenticated &amp;&amp; !inAuthGroup) {
      // User is not authenticated and trying to access protected route
      router.replace('/(auth)/login');
    } else if (isAuthenticated &amp;&amp; inAuthGroup) {
      // User is authenticated but still in auth screens
      router.replace('/(app)');
    }
  }, [isAuthenticated, isLoading, segments]);

  // Show loading screen while checking auth
  if (isLoading) {
    return (
      &lt;View style={styles.loadingContainer}&gt;
        &lt;ActivityIndicator size="large" color="#6366f1" /&gt;
      &lt;/View&gt;
    );
  }

  return &lt;{children}&gt;;
}

export default function RootLayout() {
  return (
    &lt;AuthProvider&gt;
      &lt;AuthStateListener&gt;
        &lt;Slot /&gt;
      &lt;/AuthStateListener&gt;
    &lt;/AuthProvider&gt;
  );
}

const styles = StyleSheet.create({
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: '#fff',
  },
});</code></pre>

                <!-- SVG: Auth Flow Visualization -->
                <div class="svg-container" style="text-align: center; margin: 2rem 0;">
                    <svg viewBox="0 0 650 280" style="max-width: 100%; height: auto; font-family: system-ui, sans-serif;">
                        <!-- Background -->
                        <rect width="650" height="280" fill="#f8f9fa"/>
                        
                        <!-- Title -->
                        <text x="325" y="25" text-anchor="middle" font-size="14" font-weight="bold" fill="#333">Protected Routes Flow</text>
                        
                        <!-- Auth Check -->
                        <rect x="250" y="45" width="150" height="40" fill="#e3f2fd" stroke="#2196F3" stroke-width="2" rx="20"/>
                        <text x="325" y="70" text-anchor="middle" font-size="12" fill="#1565c0">isAuthenticated?</text>
                        
                        <!-- Branches -->
                        <line x1="250" y1="65" x2="150" y2="65" stroke="#666" stroke-width="2"/>
                        <line x1="150" y1="65" x2="150" y2="120" stroke="#666" stroke-width="2"/>
                        <text x="180" y="90" font-size="10" fill="#666">false</text>
                        
                        <line x1="400" y1="65" x2="500" y2="65" stroke="#666" stroke-width="2"/>
                        <line x1="500" y1="65" x2="500" y2="120" stroke="#666" stroke-width="2"/>
                        <text x="440" y="90" font-size="10" fill="#666">true</text>
                        
                        <!-- Auth Group -->
                        <rect x="50" y="120" width="200" height="130" fill="#fff3cd" stroke="#ffc107" stroke-width="2" rx="8"/>
                        <text x="150" y="145" text-anchor="middle" font-size="12" font-weight="bold" fill="#f57c00">(auth) Group</text>
                        <rect x="70" y="160" width="160" height="28" fill="#fff" stroke="#ffe082" rx="4"/>
                        <text x="150" y="179" text-anchor="middle" font-size="11" fill="#333">login.tsx</text>
                        <rect x="70" y="195" width="160" height="28" fill="#fff" stroke="#ffe082" rx="4"/>
                        <text x="150" y="214" text-anchor="middle" font-size="11" fill="#333">register.tsx</text>
                        
                        <!-- App Group -->
                        <rect x="400" y="120" width="200" height="130" fill="#e8f5e9" stroke="#4CAF50" stroke-width="2" rx="8"/>
                        <text x="500" y="145" text-anchor="middle" font-size="12" font-weight="bold" fill="#2e7d32">(app) Group</text>
                        <rect x="420" y="160" width="160" height="28" fill="#fff" stroke="#a5d6a7" rx="4"/>
                        <text x="500" y="179" text-anchor="middle" font-size="11" fill="#333">(tabs)/</text>
                        <rect x="420" y="195" width="160" height="28" fill="#fff" stroke="#a5d6a7" rx="4"/>
                        <text x="500" y="214" text-anchor="middle" font-size="11" fill="#333">Protected screens</text>
                        
                        <!-- Redirect arrows -->
                        <path d="M250,180 C300,180 300,220 350,220" stroke="#ef4444" stroke-width="2" fill="none" stroke-dasharray="5,5" marker-end="url(#arrowRed)"/>
                        <text x="300" y="210" text-anchor="middle" font-size="9" fill="#ef4444">redirect if authed</text>
                        
                        <path d="M400,180 C350,180 350,220 300,220" stroke="#ef4444" stroke-width="2" fill="none" stroke-dasharray="5,5" marker-end="url(#arrowRedLeft)"/>
                        <text x="350" y="245" text-anchor="middle" font-size="9" fill="#ef4444">redirect if not authed</text>
                        
                        <defs>
                            <marker id="arrowRed" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#ef4444"/>
                            </marker>
                            <marker id="arrowRedLeft" markerWidth="10" markerHeight="7" refX="1" refY="3.5" orient="auto">
                                <polygon points="10 0, 0 3.5, 10 7" fill="#ef4444"/>
                            </marker>
                        </defs>
                    </svg>
                </div>

                <h3>Auth Group Layout</h3>

                <pre><code class="language-tsx">// app/(auth)/_layout.tsx
import { Stack } from 'expo-router';

export default function AuthLayout() {
  return (
    &lt;Stack
      screenOptions={{
        headerShown: false,
        animation: 'fade',
      }}
    &gt;
      &lt;Stack.Screen name="login" /&gt;
      &lt;Stack.Screen name="register" /&gt;
      &lt;Stack.Screen 
        name="forgot-password" 
        options={{
          presentation: 'modal',
          headerShown: true,
          title: 'Reset Password',
        }}
      /&gt;
    &lt;/Stack&gt;
  );
}</code></pre>

                <h3>Protected App Layout</h3>

                <pre><code class="language-tsx">// app/(app)/_layout.tsx
import { Stack } from 'expo-router';
import { useAuth } from '@/context/AuthContext';
import { Redirect } from 'expo-router';

export default function AppLayout() {
  const { isAuthenticated, isLoading } = useAuth();

  // Extra protection: redirect if somehow accessed without auth
  if (!isLoading &amp;&amp; !isAuthenticated) {
    return &lt;Redirect href="/(auth)/login" /&gt;;
  }

  return (
    &lt;Stack screenOptions={{ headerShown: false }}&gt;
      &lt;Stack.Screen name="(tabs)" /&gt;
      &lt;Stack.Screen 
        name="settings" 
        options={{
          headerShown: true,
          title: 'Settings',
          presentation: 'modal',
        }}
      /&gt;
    &lt;/Stack&gt;
  );
}</code></pre>

                <h3>Alternative: useProtectedRoute Hook</h3>

                <pre><code class="language-tsx">// hooks/useProtectedRoute.ts
import { useEffect } from 'react';
import { useRouter, useSegments } from 'expo-router';
import { useAuth } from '@/context/AuthContext';

export function useProtectedRoute() {
  const { isAuthenticated, isLoading } = useAuth();
  const segments = useSegments();
  const router = useRouter();

  useEffect(() =&gt; {
    if (isLoading) return;

    const inAuthGroup = segments[0] === '(auth)';
    const inProtectedGroup = segments[0] === '(app)';

    if (!isAuthenticated &amp;&amp; inProtectedGroup) {
      // Redirect to login
      router.replace('/(auth)/login');
    } else if (isAuthenticated &amp;&amp; inAuthGroup) {
      // Redirect to app
      router.replace('/(app)');
    }
  }, [isAuthenticated, isLoading, segments]);

  return { isLoading, isAuthenticated };
}

// Usage in any screen that needs protection
export default function ProtectedScreen() {
  const { isLoading } = useProtectedRoute();

  if (isLoading) {
    return &lt;LoadingScreen /&gt;;
  }

  return (/* ... */);
}</code></pre>
            </section>
            <!-- Authentication Screens -->
            <section id="auth-screens">
                <h2>Authentication Screens</h2>

                <p>Well-designed authentication screens are crucial for user experience. They should be clean, accessible, and handle errors gracefully.</p>

                <h3>Login Screen</h3>

                <pre><code class="language-tsx">// app/(auth)/login.tsx
import { useState } from 'react';
import {
  View,
  Text,
  TextInput,
  Pressable,
  StyleSheet,
  KeyboardAvoidingView,
  Platform,
  Alert,
  ActivityIndicator,
} from 'react-native';
import { Link, useRouter } from 'expo-router';
import { useAuth } from '@/context/AuthContext';
import { Ionicons } from '@expo/vector-icons';

export default function LoginScreen() {
  const router = useRouter();
  const { login, isLoading } = useAuth();
  
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [errors, setErrors] = useState&lt;{ email?: string; password?: string }&gt;({});

  const validate = (): boolean =&gt; {
    const newErrors: typeof errors = {};
    
    if (!email) {
      newErrors.email = 'Email is required';
    } else if (!/\S+@\S+\.\S+/.test(email)) {
      newErrors.email = 'Please enter a valid email';
    }
    
    if (!password) {
      newErrors.password = 'Password is required';
    } else if (password.length &lt; 6) {
      newErrors.password = 'Password must be at least 6 characters';
    }
    
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleLogin = async () =&gt; {
    if (!validate()) return;
    
    try {
      await login({ email, password });
      // Navigation handled by auth state listener
    } catch (error) {
      Alert.alert(
        'Login Failed',
        error instanceof Error ? error.message : 'Please check your credentials'
      );
    }
  };

  return (
    &lt;KeyboardAvoidingView
      behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
      style={styles.container}
    &gt;
      &lt;View style={styles.content}&gt;
        {/* Header */}
        &lt;View style={styles.header}&gt;
          &lt;Text style={styles.title}&gt;Welcome Back&lt;/Text&gt;
          &lt;Text style={styles.subtitle}&gt;Sign in to continue&lt;/Text&gt;
        &lt;/View&gt;

        {/* Form */}
        &lt;View style={styles.form}&gt;
          {/* Email Input */}
          &lt;View style={styles.inputGroup}&gt;
            &lt;Text style={styles.label}&gt;Email&lt;/Text&gt;
            &lt;View style={[styles.inputContainer, errors.email &amp;&amp; styles.inputError]}&gt;
              &lt;Ionicons name="mail-outline" size={20} color="#9ca3af" style={styles.inputIcon} /&gt;
              &lt;TextInput
                style={styles.input}
                placeholder="Enter your email"
                placeholderTextColor="#9ca3af"
                value={email}
                onChangeText={(text) =&gt; {
                  setEmail(text);
                  if (errors.email) setErrors(prev =&gt; ({ ...prev, email: undefined }));
                }}
                keyboardType="email-address"
                autoCapitalize="none"
                autoComplete="email"
                editable={!isLoading}
              /&gt;
            &lt;/View&gt;
            {errors.email &amp;&amp; &lt;Text style={styles.errorText}&gt;{errors.email}&lt;/Text&gt;}
          &lt;/View&gt;

          {/* Password Input */}
          &lt;View style={styles.inputGroup}&gt;
            &lt;Text style={styles.label}&gt;Password&lt;/Text&gt;
            &lt;View style={[styles.inputContainer, errors.password &amp;&amp; styles.inputError]}&gt;
              &lt;Ionicons name="lock-closed-outline" size={20} color="#9ca3af" style={styles.inputIcon} /&gt;
              &lt;TextInput
                style={styles.input}
                placeholder="Enter your password"
                placeholderTextColor="#9ca3af"
                value={password}
                onChangeText={(text) =&gt; {
                  setPassword(text);
                  if (errors.password) setErrors(prev =&gt; ({ ...prev, password: undefined }));
                }}
                secureTextEntry={!showPassword}
                autoComplete="password"
                editable={!isLoading}
              /&gt;
              &lt;Pressable onPress={() =&gt; setShowPassword(!showPassword)} style={styles.eyeButton}&gt;
                &lt;Ionicons
                  name={showPassword ? 'eye-outline' : 'eye-off-outline'}
                  size={20}
                  color="#9ca3af"
                /&gt;
              &lt;/Pressable&gt;
            &lt;/View&gt;
            {errors.password &amp;&amp; &lt;Text style={styles.errorText}&gt;{errors.password}&lt;/Text&gt;}
          &lt;/View&gt;

          {/* Forgot Password */}
          &lt;Link href="/(auth)/forgot-password" asChild&gt;
            &lt;Pressable style={styles.forgotPassword}&gt;
              &lt;Text style={styles.forgotPasswordText}&gt;Forgot Password?&lt;/Text&gt;
            &lt;/Pressable&gt;
          &lt;/Link&gt;

          {/* Login Button */}
          &lt;Pressable
            style={[styles.button, isLoading &amp;&amp; styles.buttonDisabled]}
            onPress={handleLogin}
            disabled={isLoading}
          &gt;
            {isLoading ? (
              &lt;ActivityIndicator color="#fff" /&gt;
            ) : (
              &lt;Text style={styles.buttonText}&gt;Sign In&lt;/Text&gt;
            )}
          &lt;/Pressable&gt;
        &lt;/View&gt;

        {/* Register Link */}
        &lt;View style={styles.footer}&gt;
          &lt;Text style={styles.footerText}&gt;Don't have an account? &lt;/Text&gt;
          &lt;Link href="/(auth)/register" asChild&gt;
            &lt;Pressable&gt;
              &lt;Text style={styles.linkText}&gt;Sign Up&lt;/Text&gt;
            &lt;/Pressable&gt;
          &lt;/Link&gt;
        &lt;/View&gt;
      &lt;/View&gt;
    &lt;/KeyboardAvoidingView&gt;
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#fff',
  },
  content: {
    flex: 1,
    padding: 24,
    justifyContent: 'center',
  },
  header: {
    marginBottom: 40,
  },
  title: {
    fontSize: 32,
    fontWeight: 'bold',
    color: '#111',
    marginBottom: 8,
  },
  subtitle: {
    fontSize: 16,
    color: '#6b7280',
  },
  form: {
    marginBottom: 24,
  },
  inputGroup: {
    marginBottom: 20,
  },
  label: {
    fontSize: 14,
    fontWeight: '500',
    color: '#374151',
    marginBottom: 8,
  },
  inputContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    borderWidth: 1,
    borderColor: '#e5e7eb',
    borderRadius: 12,
    backgroundColor: '#f9fafb',
  },
  inputError: {
    borderColor: '#ef4444',
  },
  inputIcon: {
    marginLeft: 16,
  },
  input: {
    flex: 1,
    paddingVertical: 16,
    paddingHorizontal: 12,
    fontSize: 16,
    color: '#111',
  },
  eyeButton: {
    padding: 16,
  },
  errorText: {
    color: '#ef4444',
    fontSize: 12,
    marginTop: 4,
  },
  forgotPassword: {
    alignSelf: 'flex-end',
    marginBottom: 24,
  },
  forgotPasswordText: {
    color: '#6366f1',
    fontSize: 14,
    fontWeight: '500',
  },
  button: {
    backgroundColor: '#6366f1',
    paddingVertical: 16,
    borderRadius: 12,
    alignItems: 'center',
  },
  buttonDisabled: {
    backgroundColor: '#a5b4fc',
  },
  buttonText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: '600',
  },
  footer: {
    flexDirection: 'row',
    justifyContent: 'center',
  },
  footerText: {
    color: '#6b7280',
    fontSize: 14,
  },
  linkText: {
    color: '#6366f1',
    fontSize: 14,
    fontWeight: '600',
  },
});</code></pre>

                <h3>Registration Screen</h3>

                <pre><code class="language-tsx">// app/(auth)/register.tsx
import { useState } from 'react';
import {
  View,
  Text,
  TextInput,
  Pressable,
  StyleSheet,
  ScrollView,
  KeyboardAvoidingView,
  Platform,
  Alert,
  ActivityIndicator,
} from 'react-native';
import { Link } from 'expo-router';
import { useAuth } from '@/context/AuthContext';
import { Ionicons } from '@expo/vector-icons';

export default function RegisterScreen() {
  const { register, isLoading } = useAuth();
  
  const [name, setName] = useState('');
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [errors, setErrors] = useState&lt;Record&lt;string, string&gt;&gt;({});

  const validate = (): boolean =&gt; {
    const newErrors: Record&lt;string, string&gt; = {};
    
    if (!name.trim()) {
      newErrors.name = 'Name is required';
    }
    
    if (!email) {
      newErrors.email = 'Email is required';
    } else if (!/\S+@\S+\.\S+/.test(email)) {
      newErrors.email = 'Please enter a valid email';
    }
    
    if (!password) {
      newErrors.password = 'Password is required';
    } else if (password.length &lt; 8) {
      newErrors.password = 'Password must be at least 8 characters';
    } else if (!/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/.test(password)) {
      newErrors.password = 'Password must include uppercase, lowercase, and number';
    }
    
    if (password !== confirmPassword) {
      newErrors.confirmPassword = 'Passwords do not match';
    }
    
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleRegister = async () =&gt; {
    if (!validate()) return;
    
    try {
      await register({ name: name.trim(), email, password });
      // Navigation handled by auth state listener
    } catch (error) {
      Alert.alert(
        'Registration Failed',
        error instanceof Error ? error.message : 'Please try again'
      );
    }
  };

  return (
    &lt;KeyboardAvoidingView
      behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
      style={styles.container}
    &gt;
      &lt;ScrollView 
        contentContainerStyle={styles.scrollContent}
        keyboardShouldPersistTaps="handled"
      &gt;
        {/* Header */}
        &lt;View style={styles.header}&gt;
          &lt;Text style={styles.title}&gt;Create Account&lt;/Text&gt;
          &lt;Text style={styles.subtitle}&gt;Sign up to get started&lt;/Text&gt;
        &lt;/View&gt;

        {/* Form */}
        &lt;View style={styles.form}&gt;
          {/* Name Input */}
          &lt;View style={styles.inputGroup}&gt;
            &lt;Text style={styles.label}&gt;Full Name&lt;/Text&gt;
            &lt;View style={[styles.inputContainer, errors.name &amp;&amp; styles.inputError]}&gt;
              &lt;Ionicons name="person-outline" size={20} color="#9ca3af" style={styles.inputIcon} /&gt;
              &lt;TextInput
                style={styles.input}
                placeholder="Enter your name"
                placeholderTextColor="#9ca3af"
                value={name}
                onChangeText={setName}
                autoComplete="name"
                editable={!isLoading}
              /&gt;
            &lt;/View&gt;
            {errors.name &amp;&amp; &lt;Text style={styles.errorText}&gt;{errors.name}&lt;/Text&gt;}
          &lt;/View&gt;

          {/* Email Input */}
          &lt;View style={styles.inputGroup}&gt;
            &lt;Text style={styles.label}&gt;Email&lt;/Text&gt;
            &lt;View style={[styles.inputContainer, errors.email &amp;&amp; styles.inputError]}&gt;
              &lt;Ionicons name="mail-outline" size={20} color="#9ca3af" style={styles.inputIcon} /&gt;
              &lt;TextInput
                style={styles.input}
                placeholder="Enter your email"
                placeholderTextColor="#9ca3af"
                value={email}
                onChangeText={setEmail}
                keyboardType="email-address"
                autoCapitalize="none"
                autoComplete="email"
                editable={!isLoading}
              /&gt;
            &lt;/View&gt;
            {errors.email &amp;&amp; &lt;Text style={styles.errorText}&gt;{errors.email}&lt;/Text&gt;}
          &lt;/View&gt;

          {/* Password Input */}
          &lt;View style={styles.inputGroup}&gt;
            &lt;Text style={styles.label}&gt;Password&lt;/Text&gt;
            &lt;View style={[styles.inputContainer, errors.password &amp;&amp; styles.inputError]}&gt;
              &lt;Ionicons name="lock-closed-outline" size={20} color="#9ca3af" style={styles.inputIcon} /&gt;
              &lt;TextInput
                style={styles.input}
                placeholder="Create a password"
                placeholderTextColor="#9ca3af"
                value={password}
                onChangeText={setPassword}
                secureTextEntry={!showPassword}
                autoComplete="new-password"
                editable={!isLoading}
              /&gt;
              &lt;Pressable onPress={() =&gt; setShowPassword(!showPassword)} style={styles.eyeButton}&gt;
                &lt;Ionicons
                  name={showPassword ? 'eye-outline' : 'eye-off-outline'}
                  size={20}
                  color="#9ca3af"
                /&gt;
              &lt;/Pressable&gt;
            &lt;/View&gt;
            {errors.password &amp;&amp; &lt;Text style={styles.errorText}&gt;{errors.password}&lt;/Text&gt;}
          &lt;/View&gt;

          {/* Confirm Password */}
          &lt;View style={styles.inputGroup}&gt;
            &lt;Text style={styles.label}&gt;Confirm Password&lt;/Text&gt;
            &lt;View style={[styles.inputContainer, errors.confirmPassword &amp;&amp; styles.inputError]}&gt;
              &lt;Ionicons name="lock-closed-outline" size={20} color="#9ca3af" style={styles.inputIcon} /&gt;
              &lt;TextInput
                style={styles.input}
                placeholder="Confirm your password"
                placeholderTextColor="#9ca3af"
                value={confirmPassword}
                onChangeText={setConfirmPassword}
                secureTextEntry={!showPassword}
                editable={!isLoading}
              /&gt;
            &lt;/View&gt;
            {errors.confirmPassword &amp;&amp; &lt;Text style={styles.errorText}&gt;{errors.confirmPassword}&lt;/Text&gt;}
          &lt;/View&gt;

          {/* Register Button */}
          &lt;Pressable
            style={[styles.button, isLoading &amp;&amp; styles.buttonDisabled]}
            onPress={handleRegister}
            disabled={isLoading}
          &gt;
            {isLoading ? (
              &lt;ActivityIndicator color="#fff" /&gt;
            ) : (
              &lt;Text style={styles.buttonText}&gt;Create Account&lt;/Text&gt;
            )}
          &lt;/Pressable&gt;
        &lt;/View&gt;

        {/* Login Link */}
        &lt;View style={styles.footer}&gt;
          &lt;Text style={styles.footerText}&gt;Already have an account? &lt;/Text&gt;
          &lt;Link href="/(auth)/login" asChild&gt;
            &lt;Pressable&gt;
              &lt;Text style={styles.linkText}&gt;Sign In&lt;/Text&gt;
            &lt;/Pressable&gt;
          &lt;/Link&gt;
        &lt;/View&gt;
      &lt;/ScrollView&gt;
    &lt;/KeyboardAvoidingView&gt;
  );
}

// Styles similar to login screen...</code></pre>

                <h3>Forgot Password Screen</h3>

                <pre><code class="language-tsx">// app/(auth)/forgot-password.tsx
import { useState } from 'react';
import {
  View,
  Text,
  TextInput,
  Pressable,
  StyleSheet,
  Alert,
  ActivityIndicator,
} from 'react-native';
import { useRouter } from 'expo-router';
import { authApi } from '@/services/auth';
import { Ionicons } from '@expo/vector-icons';

export default function ForgotPasswordScreen() {
  const router = useRouter();
  const [email, setEmail] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [isSent, setIsSent] = useState(false);

  const handleSubmit = async () =&gt; {
    if (!email || !/\S+@\S+\.\S+/.test(email)) {
      Alert.alert('Invalid Email', 'Please enter a valid email address');
      return;
    }

    try {
      setIsLoading(true);
      await authApi.forgotPassword(email);
      setIsSent(true);
    } catch (error) {
      Alert.alert(
        'Request Failed',
        error instanceof Error ? error.message : 'Please try again'
      );
    } finally {
      setIsLoading(false);
    }
  };

  if (isSent) {
    return (
      &lt;View style={styles.container}&gt;
        &lt;View style={styles.successContainer}&gt;
          &lt;View style={styles.iconCircle}&gt;
            &lt;Ionicons name="mail" size={40} color="#6366f1" /&gt;
          &lt;/View&gt;
          &lt;Text style={styles.successTitle}&gt;Check Your Email&lt;/Text&gt;
          &lt;Text style={styles.successText}&gt;
            We've sent password reset instructions to {email}
          &lt;/Text&gt;
          &lt;Pressable style={styles.button} onPress={() =&gt; router.back()}&gt;
            &lt;Text style={styles.buttonText}&gt;Back to Login&lt;/Text&gt;
          &lt;/Pressable&gt;
        &lt;/View&gt;
      &lt;/View&gt;
    );
  }

  return (
    &lt;View style={styles.container}&gt;
      &lt;View style={styles.content}&gt;
        &lt;Text style={styles.title}&gt;Reset Password&lt;/Text&gt;
        &lt;Text style={styles.description}&gt;
          Enter your email address and we'll send you instructions to reset your password.
        &lt;/Text&gt;

        &lt;View style={styles.inputContainer}&gt;
          &lt;Ionicons name="mail-outline" size={20} color="#9ca3af" style={styles.inputIcon} /&gt;
          &lt;TextInput
            style={styles.input}
            placeholder="Enter your email"
            placeholderTextColor="#9ca3af"
            value={email}
            onChangeText={setEmail}
            keyboardType="email-address"
            autoCapitalize="none"
            autoComplete="email"
            editable={!isLoading}
          /&gt;
        &lt;/View&gt;

        &lt;Pressable
          style={[styles.button, isLoading &amp;&amp; styles.buttonDisabled]}
          onPress={handleSubmit}
          disabled={isLoading}
        &gt;
          {isLoading ? (
            &lt;ActivityIndicator color="#fff" /&gt;
          ) : (
            &lt;Text style={styles.buttonText}&gt;Send Reset Link&lt;/Text&gt;
          )}
        &lt;/Pressable&gt;
      &lt;/View&gt;
    &lt;/View&gt;
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#fff',
  },
  content: {
    padding: 24,
  },
  title: {
    fontSize: 24,
    fontWeight: 'bold',
    color: '#111',
    marginBottom: 8,
  },
  description: {
    fontSize: 14,
    color: '#6b7280',
    marginBottom: 24,
    lineHeight: 20,
  },
  inputContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    borderWidth: 1,
    borderColor: '#e5e7eb',
    borderRadius: 12,
    backgroundColor: '#f9fafb',
    marginBottom: 24,
  },
  inputIcon: {
    marginLeft: 16,
  },
  input: {
    flex: 1,
    paddingVertical: 16,
    paddingHorizontal: 12,
    fontSize: 16,
    color: '#111',
  },
  button: {
    backgroundColor: '#6366f1',
    paddingVertical: 16,
    borderRadius: 12,
    alignItems: 'center',
  },
  buttonDisabled: {
    backgroundColor: '#a5b4fc',
  },
  buttonText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: '600',
  },
  successContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    padding: 24,
  },
  iconCircle: {
    width: 80,
    height: 80,
    borderRadius: 40,
    backgroundColor: '#e0e7ff',
    justifyContent: 'center',
    alignItems: 'center',
    marginBottom: 24,
  },
  successTitle: {
    fontSize: 24,
    fontWeight: 'bold',
    color: '#111',
    marginBottom: 8,
  },
  successText: {
    fontSize: 14,
    color: '#6b7280',
    textAlign: 'center',
    marginBottom: 32,
    lineHeight: 20,
  },
});</code></pre>
            </section>

            <!-- Session Management -->
            <section id="session-management">
                <h2>Session Management</h2>

                <p>Proper session management ensures security and a smooth user experience. This includes handling token expiration, background refresh, and logout scenarios.</p>

                <h3>Token Refresh Strategy</h3>

                <pre><code class="language-tsx">// services/api.ts
import { secureStorage } from './secureStorage';
import { authApi } from './auth';

const API_URL = process.env.EXPO_PUBLIC_API_URL;

let isRefreshing = false;
let refreshSubscribers: ((token: string) =&gt; void)[] = [];

function subscribeToTokenRefresh(callback: (token: string) =&gt; void) {
  refreshSubscribers.push(callback);
}

function onTokenRefreshed(token: string) {
  refreshSubscribers.forEach(callback =&gt; callback(token));
  refreshSubscribers = [];
}

export async function apiRequest&lt;T&gt;(
  endpoint: string,
  options: RequestInit = {}
): Promise&lt;T&gt; {
  const token = await secureStorage.getToken();

  const response = await fetch(`${API_URL}${endpoint}`, {
    ...options,
    headers: {
      'Content-Type': 'application/json',
      ...(token &amp;&amp; { Authorization: `Bearer ${token}` }),
      ...options.headers,
    },
  });

  // Handle 401 Unauthorized - token expired
  if (response.status === 401) {
    if (!isRefreshing) {
      isRefreshing = true;
      
      try {
        const refreshToken = await secureStorage.getRefreshToken();
        if (refreshToken) {
          const { token: newToken, refreshToken: newRefreshToken } = 
            await authApi.refreshToken(refreshToken);
          
          await secureStorage.setToken(newToken);
          if (newRefreshToken) {
            await secureStorage.setRefreshToken(newRefreshToken);
          }
          
          onTokenRefreshed(newToken);
          isRefreshing = false;
          
          // Retry original request with new token
          return apiRequest(endpoint, options);
        }
      } catch (error) {
        isRefreshing = false;
        // Refresh failed - logout user
        await secureStorage.clearAll();
        throw new Error('Session expired. Please login again.');
      }
    } else {
      // Wait for token refresh
      return new Promise((resolve, reject) =&gt; {
        subscribeToTokenRefresh(async (newToken) =&gt; {
          try {
            const result = await apiRequest&lt;T&gt;(endpoint, options);
            resolve(result);
          } catch (error) {
            reject(error);
          }
        });
      });
    }
  }

  if (!response.ok) {
    const error = await response.json().catch(() =&gt; ({}));
    throw new Error(error.message || `Request failed: ${response.status}`);
  }

  return response.json();
}</code></pre>

                <h3>Background Token Validation</h3>

                <pre><code class="language-tsx">// hooks/useSessionCheck.ts
import { useEffect, useRef } from 'react';
import { AppState, AppStateStatus } from 'react-native';
import { useAuth } from '@/context/AuthContext';

export function useSessionCheck() {
  const { refreshSession, logout, isAuthenticated } = useAuth();
  const appState = useRef(AppState.currentState);

  useEffect(() =&gt; {
    if (!isAuthenticated) return;

    const subscription = AppState.addEventListener('change', handleAppStateChange);

    return () =&gt; {
      subscription.remove();
    };
  }, [isAuthenticated]);

  const handleAppStateChange = async (nextAppState: AppStateStatus) =&gt; {
    // App came to foreground
    if (
      appState.current.match(/inactive|background/) &amp;&amp;
      nextAppState === 'active'
    ) {
      // Validate session when app becomes active
      const refreshed = await refreshSession();
      if (!refreshed) {
        // Session invalid, logout
        await logout();
      }
    }
    
    appState.current = nextAppState;
  };
}

// Usage in root layout
export default function RootLayout() {
  useSessionCheck();
  
  return (/* ... */);
}</code></pre>

                <h3>Logout Handler</h3>

                <pre><code class="language-tsx">// Complete logout implementation
import { useCallback } from 'react';
import { Alert } from 'react-native';
import { useRouter } from 'expo-router';
import { useAuth } from '@/context/AuthContext';

export function useLogout() {
  const router = useRouter();
  const { logout } = useAuth();

  const handleLogout = useCallback(async () =&gt; {
    Alert.alert(
      'Logout',
      'Are you sure you want to logout?',
      [
        { text: 'Cancel', style: 'cancel' },
        {
          text: 'Logout',
          style: 'destructive',
          onPress: async () =&gt; {
            await logout();
            // Auth state listener will handle navigation
          },
        },
      ]
    );
  }, [logout]);

  const forceLogout = useCallback(async () =&gt; {
    await logout();
    Alert.alert('Session Expired', 'Please login again.');
  }, [logout]);

  return { handleLogout, forceLogout };
}</code></pre>

                <pre class="mermaid">
sequenceDiagram
    participant App
    participant AuthContext
    participant SecureStore
    participant API
    
    Note over App: App comes to foreground
    App->>AuthContext: refreshSession()
    AuthContext->>SecureStore: getRefreshToken()
    SecureStore-->>AuthContext: refreshToken
    AuthContext->>API: POST /auth/refresh
    
    alt Token refresh success
        API-->>AuthContext: { token, refreshToken }
        AuthContext->>SecureStore: setToken(newToken)
        AuthContext-->>App: true
        Note over App: Continue with new session
    else Token refresh failed
        API-->>AuthContext: 401 Unauthorized
        AuthContext->>SecureStore: clearAll()
        AuthContext-->>App: false
        App->>App: Navigate to login
    end
                </pre>
            </section>

            <!-- Exercises -->
            <section id="exercises">
                <h2>Hands-On Exercises</h2>

                <!-- Exercise 1 -->
                <div class="exercise-card">
                    <h4>Exercise 1: Complete Auth Implementation</h4>
                    <p>Build a complete authentication system with:</p>
                    <ul>
                        <li>Login screen with email/password validation</li>
                        <li>Registration screen with password strength requirements</li>
                        <li>Protected routes that redirect to login</li>
                        <li>Persistent login across app restarts</li>
                    </ul>

                    <details>
                        <summary>üí° Hint</summary>
                        <p>Start with the AuthContext, then create the secure storage utilities. Set up your route groups <code>(auth)/</code> and <code>(app)/</code>, then implement the auth state listener in the root layout. Finally, build the login and register screens using the context methods.</p>
                    </details>
                </div>

                <!-- Exercise 2 -->
                <div class="exercise-card">
                    <h4>Exercise 2: Social Authentication</h4>
                    <p>Add social login buttons to your auth screens:</p>
                    <ul>
                        <li>Google Sign-In button</li>
                        <li>Apple Sign-In button (iOS)</li>
                        <li>Handle OAuth flow and token storage</li>
                    </ul>

                    <details>
                        <summary>‚úÖ Solution Approach</summary>
                        <pre><code class="language-tsx">// Install dependencies
// npx expo install expo-auth-session expo-crypto expo-web-browser

// Example Google Sign-In
import * as Google from 'expo-auth-session/providers/google';
import * as WebBrowser from 'expo-web-browser';

WebBrowser.maybeCompleteAuthSession();

function GoogleSignInButton() {
  const [request, response, promptAsync] = Google.useAuthRequest({
    clientId: 'YOUR_WEB_CLIENT_ID',
    iosClientId: 'YOUR_IOS_CLIENT_ID',
    androidClientId: 'YOUR_ANDROID_CLIENT_ID',
  });

  useEffect(() =&gt; {
    if (response?.type === 'success') {
      const { authentication } = response;
      // Send token to your backend
      handleGoogleLogin(authentication.accessToken);
    }
  }, [response]);

  return (
    &lt;Pressable 
      onPress={() =&gt; promptAsync()} 
      disabled={!request}
      style={styles.socialButton}
    &gt;
      &lt;Ionicons name="logo-google" size={20} /&gt;
      &lt;Text&gt;Continue with Google&lt;/Text&gt;
    &lt;/Pressable&gt;
  );
}</code></pre>
                    </details>
                </div>

                <!-- Exercise 3 -->
                <div class="exercise-card">
                    <h4>Exercise 3: Biometric Authentication</h4>
                    <p>Add biometric login for returning users:</p>
                    <ul>
                        <li>Check if biometrics are available</li>
                        <li>Enable "Login with Face ID/Fingerprint" option</li>
                        <li>Store encrypted credentials for biometric access</li>
                    </ul>

                    <details>
                        <summary>‚úÖ Solution Approach</summary>
                        <pre><code class="language-tsx">// npx expo install expo-local-authentication

import * as LocalAuthentication from 'expo-local-authentication';

async function checkBiometricSupport() {
  const compatible = await LocalAuthentication.hasHardwareAsync();
  const enrolled = await LocalAuthentication.isEnrolledAsync();
  return compatible &amp;&amp; enrolled;
}

async function authenticateWithBiometrics(): Promise&lt;boolean&gt; {
  const result = await LocalAuthentication.authenticateAsync({
    promptMessage: 'Login with biometrics',
    cancelLabel: 'Use password',
    fallbackLabel: 'Use password',
  });
  
  return result.success;
}

// In login screen
const [biometricsAvailable, setBiometricsAvailable] = useState(false);

useEffect(() =&gt; {
  checkBiometricSupport().then(setBiometricsAvailable);
}, []);

const handleBiometricLogin = async () =&gt; {
  const success = await authenticateWithBiometrics();
  if (success) {
    // Retrieve stored credentials and login
    const savedEmail = await secureStorage.get('biometric_email');
    const savedToken = await secureStorage.getToken();
    // Validate token or use saved credentials
  }
};</code></pre>
                    </details>
                </div>

                <!-- Exercise 4 -->
                <div class="exercise-card">
                    <h4>Exercise 4: Session Timeout</h4>
                    <p>Implement automatic logout after inactivity:</p>
                    <ul>
                        <li>Track user activity (taps, navigation)</li>
                        <li>Show warning before timeout</li>
                        <li>Logout after 15 minutes of inactivity</li>
                        <li>Allow user to extend session</li>
                    </ul>

                    <details>
                        <summary>üí° Hint</summary>
                        <p>Create an <code>ActivityTracker</code> context that resets a timer on any user interaction. Use <code>PanResponder</code> or wrap your app with a touch handler. Show a modal when 30 seconds remain, and call logout when the timer expires.</p>
                    </details>
                </div>
            </section>

            <!-- Summary -->
            <section id="summary">
                <h2>Summary</h2>

                <p>You've built a complete authentication system with secure storage, protected routes, and proper session management. Your app now handles login, registration, and logout flows professionally.</p>

                <div class="card" style="background: #e8f5e9; border-left: 4px solid #4CAF50;">
                    <h4>üéØ Key Takeaways</h4>
                    <ul>
                        <li><strong>Secure Storage:</strong> Always use SecureStore for tokens, never plain AsyncStorage</li>
                        <li><strong>Auth Context:</strong> Centralize auth state and methods for global access</li>
                        <li><strong>Protected Routes:</strong> Use route groups and auth state listener for automatic redirects</li>
                        <li><strong>Session Persistence:</strong> Load stored tokens on app start for seamless UX</li>
                        <li><strong>Token Refresh:</strong> Handle 401 responses with automatic token refresh</li>
                        <li><strong>Complete Logout:</strong> Clear all stored data and reset navigation state</li>
                        <li><strong>Error Handling:</strong> Show user-friendly error messages for auth failures</li>
                    </ul>
                </div>

                <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h4 style="color: white;">üîê Auth Security Checklist</h4>
                    <pre style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; color: white; margin: 0;"><code>‚úì Tokens stored in SecureStore (not AsyncStorage)
‚úì HTTPS only for all API calls
‚úì Passwords never stored locally
‚úì Token validation on app start
‚úì Automatic token refresh before expiration
‚úì Complete cleanup on logout
‚úì Session timeout for sensitive apps
‚úì Input validation on all forms
‚úì Error messages don't leak sensitive info</code></pre>
                </div>

                <h3>What's Next?</h3>

                <p>In the next lesson, we'll implement <strong>Deep Linking</strong>‚Äîallowing users to navigate directly to specific screens via URLs, push notifications, or external links.</p>
            </section>

            <!-- Lesson Navigation -->
            <div class="lesson-nav">
                <a href="m06_l05_nested_navigation.html" class="prev-link">
                    <span class="arrow">‚Üê</span>
                    <div class="nav-content">
                        <span class="nav-label">Previous</span>
                        <span class="nav-title">Nested Navigation</span>
                    </div>
                </a>
                
                <a href="index.html" class="home-link" title="Back to Course Home">
                    üè†
                </a>
                
                <a href="m06_l07_deep_linking.html" class="next-link">
                    <div class="nav-content">
                        <span class="nav-label">Next</span>
                        <span class="nav-title">Deep Linking</span>
                    </div>
                    <span class="arrow">‚Üí</span>
                </a>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer>
        <div class="container">
            <p>&copy; 2025 React Native & Expo Course. All rights reserved.</p>
            <p>
                <a href="index.html">Home</a> |
                <a href="index.html#modules">Modules</a> |
                <a href="index.html#appendices">Appendices</a>
            </p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="js/course-enhancements.js"></script>
</body>
</html>
